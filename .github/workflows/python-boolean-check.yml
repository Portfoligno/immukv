name: Python Boolean Check

on:
  schedule:
    # Run 3 times daily at random times (deterministic from repo name hash)
    - cron: '39 4 * * *'   # 04:39 UTC
    - cron: '6 20 * * *'   # 20:06 UTC
    - cron: '46 23 * * *'  # 23:46 UTC
  workflow_dispatch: # Allow manual trigger

jobs:
  check-python-boolean-expressions:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      issues: write
      id-token: write
    steps:
      - name: Checkout branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'schedule' && 'main' || github.ref }}

      - name: Run Claude Code to check for implicit boolean expressions
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          show_full_output: true
          claude_args: --allowedTools 'Bash(gh issue create:*),Bash(gh issue list:*)'
          prompt: |
            Enforce strict boolean expressions for Python Optional types, equivalent to TypeScript's `@typescript-eslint/strict-boolean-expressions` rule.

            **CRITICAL: All implicit truthiness checks on Optional types are violations, regardless of the type's "valid values".**

            This codebase uses explicit `is not None` checks in TypeScript (enforced by @typescript-eslint/strict-boolean-expressions).
            Python must follow the same strict standard.

            **Violations to check:**
            - `if optional_value:` → should be `if optional_value is not None:`
            - `if not optional_value:` → should be `if optional_value is None:`
            - `value if optional_value else default` → should be `value if optional_value is not None else default`

            Where `optional_value` has type `Optional[T]` for any T (including str, objects, etc.)

            **DO NOT rationalize violations as "safe":**
            - "ETags cannot be empty" - IRRELEVANT, must use `is not None`
            - "Version IDs are never empty" - IRRELEVANT, must use `is not None`
            - "This type doesn't have falsy values" - IRRELEVANT, must use `is not None`

            The rule is: if the type is Optional[T], use explicit None checks. No exceptions.

            **Task:**
            1. Search for all Python files with Optional type annotations
            2. Identify ALL implicit truthiness checks on Optional types
            3. Create a detailed report of all violations found (file path, line number, code snippet)

            **If violations found:**
            - First check if an open issue with title "Python boolean violations detected" already exists
            - If such an issue exists, exit without creating a duplicate
            - If no such issue exists, create a GitHub issue with title "Python boolean violations detected"
            - Include in the issue body:
              1. Start with: "@claude Please fix these violations:"
              2. The detailed violation report (file path, line number, code snippet for each violation)
              3. Step-by-step instructions:
                 - Fix all violations by replacing with explicit `is not None` or `is None` checks
                 - Commit and push your changes
                 - Check CI status - if it fails, fix the issues and push again
                 - Once CI passes, run `gh pr create` to create the PR

            **If no violations found:**
            - Exit successfully without creating an issue
            - Log that no violations were found
